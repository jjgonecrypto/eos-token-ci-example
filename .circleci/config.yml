version: 2
jobs:
  prepare:
    docker:
      - image: 'circleci/node:8.11'
    working_directory: '~'
    steps:
      - checkout
      - run: git submodule update --init --recursive
      - restore_cache:
          keys:
            - 'v1.0-dependencies-{{ checksum "package.json" }}'
            - v1.0-dependencies-
      - run: npm install
      - run: npm run lint
      - save_cache:
          paths:
            - node_modules
          key: 'v1.0-dependencies-{{ checksum "package.json" }}'
      - persist_to_workspace:
          root: .
          paths:
            - node_modules
            - eosio.contracts
  compile:
    docker:
      - image: 'justinjmoses/eosio-cdt:1.4.1'
    working_directory: '~'
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Test
          command: >
            mkdir build && \ eosio-cpp
            eosio.contracts/eosio.token/src/eosio.token.cpp -I \
            eosio.contracts/eosio.token/include/ -o build/eosio.token.wasm
      - persist_to_workspace:
          root: .
          paths:
            - node_modules
            - eosio.contracts
            - build
  test:
    docker:
      - image: 'circleci/node:8.11'
      - image: 'eosio/eos:v1.4.3'
        command:
          - keosd
          - '--http-server-address=0.0.0.0:5555'
      - image: 'eosio/eos:v1.4.3'
        command:
          - nodeos
          - '--http-server-address=0.0.0.0:7777'
          - '--plugin=eosio::producer_plugin'
          - '--plugin=eosio::http_plugin'
          - '--plugin=eosio::chain_api_plugin'
          - '--plugin=eosio::history_plugin'
          - '--plugin=eosio::history_api_plugin'
          - '--plugin=eosio::http_plugin'
          - '--data-dir=/mnt/dev/data'
          - '--enable-stale-production'
          - '--producer-name=eosio'
          - '--config-dir=/mnt/dev/config'
          - '--access-control-allow-origin=*'
          - '--contracts-console'
          - '--http-validate-host=false'
          - '--filter-on=*'
    working_directory: '~'
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run: ls -lat
      - run: ls -lat node_modules
      - run: ls -lat build
      - run: 'curl http://localhost:5555'
      - run: 'curl http://localhost:7777/v1/chain/get_info'
      - run: node --version
      - run: npm test
workflows:
  version: 2
  dev:
    jobs:
      - prepare
      - compile:
          requires:
            - prepare
      - test:
          requires:
            - compile
